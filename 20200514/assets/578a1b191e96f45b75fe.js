"use strict";(this.webpackChunkdiscord_app=this.webpackChunkdiscord_app||[]).push([["95437"],{441894:function(e,n,t){t.d(n,{J:function(){return c}});var r=t(442837),u=t(19780),l=t(977059),i=t(760373);function c(e){let{channelId:n,location:t}=e,c=l.c.useExperiment({location:t});return(0,r.e7)([u.Z],()=>(function(e,n,t){var r;let{enabled:l}=n;if(!l||null==e||u.Z.getChannelId()!==e)return!1;let c=null===(r=t.getSecureFramesState())||void 0===r?void 0:r.version;return null!=c&&c>i.HK})(n,c,u.Z))}},210975:function(e,n,t){t.d(n,{m$:function(){return Z},wV:function(){return C}});var r=t(470079),u=t(442837),l=t(470956),i=t(314897),c=t(592125),a=t(979651),o=t(441894);function s(e){let n=(0,u.e7)([a.Z],()=>a.Z.getVoiceStatesForChannel(e)),t=r.useMemo(()=>Object.keys(n),[n]);return(0,l.Yp)(e,t)}function d(e){let{channelId:n,location:t}=e,r=(0,o.J)({channelId:n,location:t}),l=(0,u.e7)([c.Z],()=>{var e;return(null===(e=c.Z.getChannel(n))||void 0===e?void 0:e.isGuildStageVoice())===!0});return r&&!l}function f(e,n){return!1}function C(e){var n,t;let{userId:r,channelId:l,location:c}=e,a=s(l),o=d({channelId:l,location:c}),f=(0,u.e7)([i.default],()=>i.default.getId());return o&&a.has(f)&&null!=r&&a.has(r)&&(n=0,t=0,!1)}function Z(e){let{channelId:n,location:t}=e,l=s(n),c=d({channelId:n,location:t}),a=(0,u.e7)([i.default],()=>i.default.getId());return r.useMemo(()=>!!(c&&l.has(a))&&Array.from(l).every(e=>{var n,t;return n=0,t=0,e===a}),[n,a,c,l])}},470956:function(e,n,t){t.d(n,{Es:function(){return g},Eu:function(){return I},Yp:function(){return N},bt:function(){return h}}),t(47120),t(653041);var r=t(470079),u=t(392711),l=t(259443),i=t(286379),c=t(442837),a=t(413523),o=t(797614),s=t(314897),d=t(878884),f=t(19780),C=t(979651),Z=t(413402);let E=new l.Y("RTCConnectionDesyncHooks");function g(e,n){let t=(0,Z.M)(),l=(0,c.e7)([d.Z,f.Z],()=>t&&e===f.Z.getChannelId()?d.Z.getDesyncedVoiceStates():null);return r.useMemo(()=>(function(e,n){if(!(0,Z.i)()||null==e||0===e.length)return n;let t=[],r=new Set;for(let e of n)t.push(e),r.add(e.user.id);return e.forEach(e=>{r.has(e.user.id)&&(E.info("Found duplicate user voice state: ".concat(e.user.id,".")),o.Z.increment({name:i.V.RTC_CONNECTION_DUPLICATE_USER})),t.splice((0,u.sortedIndexBy)(t,e,e=>{let{comparator:n}=e;return n}),0,e)}),t})(l,n),[l,n])}function h(e,n){let t=function(e){let n=(0,Z.M)();return(0,c.e7)([d.Z,f.Z],()=>n&&e===f.Z.getChannelId()?d.Z.getDesyncedParticipants():null)}(e);return r.useMemo(()=>(function(e,n){if(!(0,Z.i)()||null==e||0===e.length)return n;let t=[...n];return e.forEach(e=>{t.splice((0,u.sortedIndexBy)(t,e,e=>(0,a.Yr)(e)),0,e)}),t})(t,n),[t,n])}function N(e,n){let t=(0,Z.M)(),u=(0,c.e7)([d.Z,f.Z],()=>t&&e===f.Z.getChannelId()?d.Z.getDesyncedUserIds():null);return r.useMemo(()=>{let e=new Set;return n.forEach(n=>e.add(n)),null==u||u.forEach(n=>e.add(n)),e},[u,n])}function I(e,n){let t=(0,Z.M)(),u=(0,c.e7)([s.default],()=>s.default.getId()===n),l=(0,c.e7)([f.Z],()=>f.Z.getChannelId()),i=r.useRef(null),[a,o]=r.useState(!1),[d,E]=r.useState(!1),g=(0,c.e7)([f.Z,C.Z],()=>null!=n&&null!=e&&f.Z.getChannelId()===e&&null!=C.Z.isInChannel(e,n)&&f.Z.isUserConnected(n)),h=(0,c.e7)([f.Z,C.Z],()=>null!=n&&null!=e&&f.Z.getChannelId()===e&&null!=C.Z.isInChannel(e,n)&&!f.Z.isUserConnected(n));return r.useEffect(()=>{g&&E(!0)},[g]),r.useEffect(()=>{l!==e&&E(!1)},[e,l]),r.useEffect(()=>(h&&null==i.current?i.current=setTimeout(()=>{i.current=null,o(!0)},250):(clearTimeout(i.current),i.current=null,o(!1)),()=>{clearTimeout(i.current),i.current=null}),[h]),t&&!u&&d&&a}},413402:function(e,n,t){t.d(n,{M:function(){return l},i:function(){return u}});let r=(0,t(818083).B)({kind:"user",id:"2024-06_rtc_voice_state_sync_experiment",label:"RTC and Voice State Desync Fixes",defaultConfig:{enabled:!1},treatments:[{id:1,label:"Desync fixes enabled",config:{enabled:!0}}]});function u(){let{enabled:e}=r.getCurrentConfig({location:"isRTCVoiceStateDesyncExperimentEnabled"});return e}function l(){let{enabled:e}=r.useExperiment({location:"useIsRTCVoiceStateDesyncExperimentEnabled"});return e}},878884:function(e,n,t){t(47120),t(724458);var r,u,l,i,c=t(286379),a=t(442837),o=t(570140),s=t(642047),d=t(797614),f=t(413402),C=t(189786),Z=t(5192),E=t(592125),g=t(19780),h=t(594174),N=t(979651),I=t(938475),S=t(981631),T=t(354459);let _=new s.Z,m=new s.Z,p=new Set,v=!1;function y(e,n,t){let r=new C.Z({userId:e.id,channelId:t}),u=(0,I.PH)(r,null!=n?n:S.ME,e.id);_.set(e.id,u);let l={type:T.fO.USER,user:e,id:e.id,streamId:null,voiceState:r,voicePlatform:null,speaking:!1,lastSpoke:0,soundsharing:!1,ringing:!1,userNick:Z.ZP.getName(n,t,e),localVideoDisabled:!1};m.set(e.id,l)}function O(e){let n=_.delete(e),t=m.delete(e),r=p.delete(e);return n||t||r}function D(){var e;let n=g.Z.getChannelId();if(null==n)return!1;let t=null===(e=E.Z.getChannel(n))||void 0===e?void 0:e.getGuildId(),r=!1;return p.forEach(e=>{if(null!=N.Z.getVoiceStateForChannel(n,e)){p.delete(e);return}let u=h.default.getUser(e);null!=u&&(r=!0,p.delete(e),y(u,t,n))}),r}function b(){_.clear(),m.clear(),p.clear()}class V extends(r=a.ZP.Store){initialize(){this.waitFor(N.Z,h.default,E.Z,g.Z),this.syncWith([h.default],D)}get desyncedVoiceStatesCount(){return _.size()}getDesyncedUserIds(){return _.keys()}getDesyncedVoiceStates(){return _.values()}getDesyncedParticipants(){return m.values()}}i="RTCConnectionDesyncStore",(l="displayName")in(u=V)?Object.defineProperty(u,l,{value:i,enumerable:!0,configurable:!0,writable:!0}):u[l]=i,n.Z=new V(o.Z,{CONNECTION_OPEN:function(){v=(0,f.i)(),b()},VOICE_CHANNEL_SELECT:b,RTC_CONNECTION_STATE:function(e){let{state:n}=e;if(n!==S.hes.DISCONNECTED)return!1;b()},VOICE_STATE_UPDATES:function(e){let{voiceStates:n}=e,t=g.Z.getChannelId();return null!=t&&n.reduce((e,n)=>{let{userId:r,channelId:u}=n;return u===t&&!!O(r)||e},!1)},RTC_CONNECTION_CLIENT_CONNECT:function(e){let{userIds:n,guildId:t,channelId:r}=e;return n.reduce((e,n)=>{if(null!=N.Z.getVoiceStateForChannel(r,n))return e;let u=h.default.getUser(n);return null==u?(null==t&&v&&d.Z.increment({name:c.V.RTC_CONNECTION_DESYNC_STORE_UNKNOWN_USER}),p.add(n),e):(y(u,t,r),!0)},!1)},RTC_CONNECTION_CLIENT_DISCONNECT:function(e){let{userId:n}=e;return O(n)}})}}]);
//# sourceMappingURL=578a1b191e96f45b75fe.js.map